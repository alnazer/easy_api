<?php
    
    namespace app\Controller;

    use Alnazer\Easyapi\Behaviours\Auth\BearerAuth;
    use Alnazer\Easyapi\Behaviours\Auth\MultiAuth;
    use Alnazer\Easyapi\Behaviours\RateLimit\RateLimit;
    use Alnazer\Easyapi\Database\MigrateBuilder;
    use Alnazer\Easyapi\Database\Schema;
    use Alnazer\Easyapi\System\Controller;
    use app\Models\User;

    class SiteController extends Controller
    {

        public function behaviour($behaviours = [])
        {
            $behaviours["auth"] = [
                "class"=> MultiAuth::class,
                'methods' => [
                    //BasicAuth::class,
                    BearerAuth::class,
                ],
                "execute" => ["register","encrypt"]
            ];
            $behaviours["rate_limit"] = [
                "class"=> RateLimit::class,
                "everySecond" => 3,
                'requestCount' => 3,
                'allowDisplayInHeader' => true
            ];
            return parent::behaviour($behaviours); // TODO: Change the autogenerated stub
        }

        /**
         * @throws \Exception
         */
        public function encrypt()
        {

            return[ (Schema::createTable("asd",function (MigrateBuilder $table){
                $table->tinyInt("id")->notNull()->auto_increment();
                $table->string("username")->null()->default(0);
                $table->string("id")->notNull();
                $table->primary(["id"]);
            }))];
            /*
            $text = "My name Is Hassan";
            $encrypt = $this->security->encrypt($text);
            $string = "Ex0WnGAnbeg39wU9FAf0k3LyO910wbN/riiSviRu7qzJg8hVnfa+h6Z9TH4GOX12nrb9s+G2xgwtyeJbuNdtGtRPolUVr97E4aahrmxC/9k";
            return [
                "encrypt" => $encrypt,
                "decrypt" => $this->security->decrypt($encrypt),
                "decrypt_after_change_key" => $this->security->decrypt($string),
                "random" => security()->generateRandomString(14,"0123456789")."-".security()->getRandomToken(4),
            ];
            */
        }
        public function register(){

            return  User::insert(["username"=> "admin".rand(1,20),"email"=> "hassan".rand(1,20)."@gmail.com","password"=> User::hashPassword("342342424234"),"access_token"=> security()->getRandomToken(50)]);
        }

        /**
         * @param $id
         * @param $name
         * @param $mobile
         * @return array|null[]
         */
        public function index($id = null,$name = null,$mobile = null)
        {
            //Cache::add(range(1,20),13000);
           return [
               'id'=> $id,
               "name" => $name,
               'mobile' => $mobile,
               //'get' => Cache::get("bc2a2917b4640a146f2fdcb9546b3d27c69b11df1e6c4e3c5aad3d46e5ce"),
               //'findBy' => User::findById(3),
               /*"all"=>User::select(["id ","username ","id "])->all(),
               "all_selec"=>User::select("*")->whereIn("id",[1,2,3])->all(),
               "insert" => User::insert(["username"=> "admin".rand(1,20),"email"=> "hassan".rand(1,20)."@gmail.com","password"=> sha1(time()),"access_token"=>sha1(time()*time())]),
               "query"=>User::select("*")->where(["username"=> "admin","email"=> "hassan@gmail.com"])->all(),
               "queryCount"=>User::select("*")->where(["username"=> "admin","email"=> "hassan@gmail.com"])->count(),
               "one"=>User::one(),
               "last"=>User::last(),
               "count"=>User::count(),
               "first"=>User::first(),
               "inputs" => $this->request->get(),
               "name" => ["first"=> "hassan", "last" => "Attia"],
               "email" => "hassan@gmail.com",
               "mobile" => "90033807",
               "nation" => [
                   "country" => [
                       "name" => "egypt",
                       "code" => "EG",
                       "currency" => [
                           "title" => "Egypt bound",
                           "ex" => 3.0,
                       ]
                   ]
               ],*/
           ];
        }

        public function beforeCall($action = [])
        {
            return parent::beforeCall($action); // TODO: Change the autogenerated stub
        }
    }